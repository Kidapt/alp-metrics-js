(function(){var e=undefined;var r=undefined;var n="https://service.kidaptive.com";var t="/v3/openid/user/web";var i="/v3/learner";var a="/v3/user/logout";var o="/v3/metric";var u="Unauthorized";var f="application/json";var c="No ALP learner found with provider ID ";var d="alp_metrics.js requires jQuery >= 3.0.0";var s="Call initAlpAuth to set ALP authentication parameters";var v=false;var h=[];var l=function(){return $&&$().jquery&&$().jquery>="3.0.0"};var p=function(){return e&&r};var w=function(e){return h.filter(function(r){return r.providerId==e})[0]};var m=function(){var e=$("iframe#alp-auth")[0];if(!e){$("body").append(e=$("<iframe id='alp-auth' src='about:blank' width='0' height='0' frameborder='0'/>")[0])}return e};var j=function(e){return e.then(function(e){return e},function(e,r,n){throw new Error(n)})};var y=function(r,t,i,a){var u={learnerId:r,items:[]};if(t instanceof Array){t.forEach(function(e){if(typeof e=="string"){u.items.push({name:e,start:i,end:a})}else{u.items.push(e)}})}else{u.items.push({name:t,start:i,end:a})}return j($.ajax(n+o,{method:"POST",headers:{"api-key":e},data:JSON.stringify(u),contentType:f,xhrFields:{withCredentials:true}}))};var E=function(){var i=$.Deferred();var a=m();$(a).off("load").one("load",function(){a.onload=undefined;if(a.contentDocument&&a.contentDocument.URL==r){i.resolve()}else{i.reject(new Error(u))}});a.src=n+t+"?api_key="+encodeURIComponent(e)+"&redirect_uri="+encodeURIComponent(r);return i.then(A).then(function(e){v=true;h=e},function(e){v=false;h=[];throw e})};var A=function(){return j($.ajax(n+i,{method:"GET",headers:{"api-key":e},xhrFields:{withCredentials:true}}))};window.initAlpAuth=function(t,i,a){e=t;r=i;a=a?a:{};if(a["dev"]){n="https://develop.kidaptive.com"}};window.getAlpMetrics=function(e,r,n,t){if(!l()){return $.Deferred().reject(new Error(d))}if(!p()){return $.Deferred().reject(new Error(s))}var i=$.Deferred();var a=w(e);if(!v||!a){i.reject(new Error(u))}else{y(a.id,r,n,t).then(function(e){i.resolve(e)}).catch(function(e){i.reject(e)})}return i.catch(function(i){if(i.message==u){return E().then(function(){var i=w(e);if(!i){throw new Error(c+e)}return y(i.id,r,n,t)})}else{throw i}})};window.doAlpLogout=function(){if(!l()){return $.Deferred().reject(new Error(d))}if(!p()){return $.Deferred().reject(new Error(s))}return j($.ajax(n+a,{method:"POST",headers:{"api-key":e},xhrFields:{withCredentials:true}})).always(function(){v=false;h=[]})}})();
